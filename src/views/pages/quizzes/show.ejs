<!-- progress ------------------------------------------------------- -->
<div class="sticky-top mb-4" style="top:72px; z-index:2;">
    <div class="progress" style="height:.5rem;">
        <div id="q-progress" class="progress-bar bg-success" style="width:0%"></div>
    </div>
</div>

<h1 class="h4 mb-2 fw-semibold"><%= quiz.title %></h1>
<p class="text-muted mb-4"><%= quiz.description %></p>

<form action="/quizzes/<%= quiz._id %>" method="POST" id="quizForm">

    <% questions.forEach((q, i) => { %>
        <div class="card mb-4 border-2" style="border-color:var(--brand-mint-300);">
            <div class="card-body">
                <p class="fw-bold"><%= i + 1 %>. <%= q.text %></p>

                <% /* SINGLE / TRUEFALSE ----------------------------------- */ %>
                <% if (q.type === 'single' || q.type === 'truefalse') { %>
                    <div class="btn-group-vertical w-100" role="group">
                        <% q.options.forEach(o => { %>
                            <input type="radio"
                                   class="btn-check"
                                   name="answers[<%= q._id %>]"
                                   id="opt-<%= o._id %>"
                                   value="<%= o._id %>" required>
                            <label class="btn btn-outline-primary text-start"
                                   for="opt-<%= o._id %>"><%= o.text %></label>
                        <% }) %>
                    </div>

                    <% /* MULTIPLE ------------------------------------------- */ %>
                <% } else if (q.type === 'multiple') { %>
                    <div class="btn-group-vertical w-100" role="group">
                        <% q.options.forEach(o => { %>
                            <input type="checkbox"
                                   class="btn-check"
                                   name="answers[<%= q._id %>]"
                                   id="opt-<%= o._id %>"
                                   value="<%= o._id %>">
                            <label class="btn btn-outline-primary text-start"
                                   for="opt-<%= o._id %>"><%= o.text %></label>
                        <% }) %>
                    </div>

                    <% /* TEXT ------------------------------------------------ */ %>
                <% } else { %>
                    <textarea name="answers[<%= q._id %>]"
                              class="form-control"
                              rows="2"
                              placeholder="Ваш ответ…" required></textarea>
                <% } %>

            </div>
        </div>
    <% }) %>

    <button class="btn btn-primary w-100 py-2">Отправить ответы</button>
</form>

<script>
    (() => {
        'use strict';

        const form = document.getElementById('quizForm');
        const qCount = <%= questions.length %>;
        const bar = document.getElementById('q-progress');

        /* авто-фокус на первом text-input */
        form.querySelector('textarea, input[type="text"]')?.focus();

        /* прогресс-бар + active-state для labels */
        form.addEventListener('change', () => {
            const answered = new Set(
                [...new FormData(form).keys()].map(k => k.match(/answers\[(.+)\]/)?.[1])
            ).size;
            bar.style.width = (answered / qCount * 100) + '%';
        });

        /* активный стиль для btn-check */
        document.querySelectorAll('.btn-check').forEach(inp => {
            inp.addEventListener('change', () => {
                const lbl = form.querySelector(`label[for="${inp.id}"]`);
                lbl.classList.toggle('active', inp.checked);
            });
        });
    })();
</script>
